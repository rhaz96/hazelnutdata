---
title: Forecasting Capital BikeShare Ridership
author: Robert Hazell
date: '2020-03-31'
slug: forecasting-capital-bikeshare-ridership
categories: []
tags: ["time series", "R", "projects", "machine learning"]
description: ''
---

<script src="/rmarkdown-libs/kePrint/kePrint.js"></script>


<center>
<img src="/project/testing-mathjax-latex_files/capitalbike.png" />
</center>
<center>
<p class="caption">
<a href="https://dc.curbed.com/2019/8/22/20828525/capital-bikeshare-dc-college-students-transportation-biking">Capital BikeShare docking station</a>
</p>
</center>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>I love to bike, especially during the spring and summer. As a New York City resident the city affords miles of urban bike paths, my favorite being the seamless connection between Riverside and Hudson River parks. Of course thousands (if not millions) of others enjoy biking throughout the country, and if you don’t own a bike you can rent one through various bike programs, like NYC’s <a href="https://www.citibikenyc.com/">Citi Bike</a> and Washington DC’s <a href="https://www.capitalbikeshare.com/">Capital BikeShare</a> (CB henceforth). The latter is the focus of this report.</p>
</div>
<div id="background-and-motivation" class="section level2">
<h2>Background and Motivation</h2>
<p>CB has maintained <a href="https://s3.amazonaws.com/capitalbikeshare-data/index.html">ridership data</a> since 2010, but I first came across their data on the UCI Machine Learning Repository <a href="https://archive.ics.uci.edu/ml/datasets/Bike+Sharing+Dataset">here</a> which featured data from 2011-2012. A more complete analysis of CB’s ridership requires more data, so UCI’s data will be merged with 2013-2017 data from CB’s website.</p>
<p>The objective is to create 30-day trip forecasts by comparing several competing time series models. This task is relevant to CB officials since they could predict how much revenue to expect for any 30 day period. While location-based data isn’t utilized in this analysis, using it could help identify areas needing increased bike availability. And although daily data is used here, hourly forecasts would enable cyclists to gauge and anticipate future bike demand.</p>
</div>
<div id="literature-review" class="section level2">
<h2>Literature Review</h2>
<p>Bike share programs are relatively new, but research on factors affecting ridership has been conducted. <a href="https://nacto.org/wp-content/uploads/2012/02/Bike-Lanes-and-Other-Determinants-of-Capital-Bikeshare-Trips-Buck-et-al-12-3539.pdf">Buck and Buehler 2011</a> have conducted research on CB ridership at the station level during CB’s first six months of operation. Using stepwise multiple regression model, they conclude average daily ridership is affected by the number of bike lines within 1/2 mile of a station, the number of Washington DC Alcohol Beverage Regulation Administration (ABRA) license holders, and the weighted average percentage of households with no access to an automobile (adjusted <span class="math inline">\(R^2\)</span> = 0.66, n=91).</p>
<p><a href="https://nacto.org/wp-content/uploads/2015/07/2012_Rixey_Station-Level-Forecasting-of-Bike-Sharing-Ridership.pdf">Rixey 2012</a> investigates the natural logarithm of monthly bike rentals across three bike share programs (including CB) from the first operating season of each, on a station basis using multiple regression. Rixey reduces his 19 candidate variables to 11 (plus an intercept) that include various socioeconomic and bike system architecture variables, yielding an adjusted <span class="math inline">\(R^2\)</span> of ~0.8.</p>
<p><a href="https://www.researchgate.net/profile/Khandker_Nurul_Habib2/publication/286379583_Effects_of_Built_Environment_and_Weather_on_Bike_Sharing_Demand_A_Station_Level_Analysis_of_Commercial_Bike_Sharing_in_Toronto/links/56684b7c08ae7dc22ad1c992/Effects-of-Built-Environment-and-Weather-on-Bike-Sharing-Demand-A-Station-Level-Analysis-of-Commercial-Bike-Sharing-in-Toronto.pdf">El-Assi, et al 2017</a> perform a similar types of analysis of Toronto’s bike share program, developing models for weekday, weekend, station origin, and station destination ridership. Adjusted <span class="math inline">\({R^2}\)</span> values hover around 0.66.</p>
<p><a href="https://pdfs.semanticscholar.org/8a39/c1df91725ac27ea0c413360c3592b911d17a.pdf">Wang et al 2012</a> use 19 total socioeconomic variables to develop a regression model for station level, 2011 ridership of the Nice Ride bike share program in Minneapolis. Notably no weather variables are included. They achieve an adjusted Adjusted <span class="math inline">\({R^2}\)</span> of approximately 0.87.</p>
<p>All of that research focuses more on identifying important variables and trends for ridership but not forecasting (extrapolating) future ridership. That is the focus of this analysis. It’s important to note high <span class="math inline">\(R^2\)</span> values don’t necessarily translate into accurate forecasts since models can overfit the data. That issue was not examined in their analyses, so it’s unsure how predictive their models are. However, the variables they used may be helpful additions to this analysis (at some later date).</p>
</div>
<div id="data-cleaning-and-feature-engineering" class="section level2">
<h2>Data Cleaning and Feature Engineering</h2>
<p>Data comes from three sources: UCI 2011-2012 data, historical weather data from NOAA for 2011-2017, and the CB ridership data from 2013-2017. We’ll go through each one; as the code is sufficiently commented, summaries of the data wrangling should suffice.</p>
<div id="uci-data-2011-2012" class="section level3">
<h3>UCI Data (2011-2012)</h3>
<p>We begin with the UCI data since it’s the quickest and serves as the baseline for how the remainder of data from 2013-2017 is handled.</p>
<p>Relevant revisions include:</p>
<ul>
<li>removing unnecessary weather and calendar variables - they’ll be replaced later on with other variables</li>
<li>converting relevant calendar variables into factor/categorical variables</li>
<li>converting weather data to their original, non-normalized scales</li>
<li>adding a week of the month column. This isn’t completely necessary now, but it’s used later to define/encode holiday dates in the 2013-2017 data</li>
</ul>
<pre class="r"><code># main libraries used; others will be loaded later
library(tswge)
library(fpp2)
library(lubridate)
library(dplyr)

############## Begin with UCI data ##############
# import 2011 and 2012 UCI data - will be merged with 2013-2017 data later
# change file path to match yours!
bikes_uci &lt;- read.csv(&quot;day.csv&quot;)
# remove atemp since it adds no info on top of temp
# remove season and yr - unnecessary calendar variables
# remove instant; remove workingday - weekday covers this
# remove weathersit - cumbersome to define; this is replaced with actual rain and snowfall data
bikes_uci &lt;- bikes_uci[, -c(1,3,4,8,9,11)]
# rename dteday to TripDate
colnames(bikes_uci)[1] &lt;- &quot;TripDate&quot;
# add 1 to weekday to make consistent with everyday understanding (1-7)
bikes_uci$weekday &lt;- bikes_uci$weekday+1
# convert calendar variables to factor variables
bikes_uci[, 2:4] &lt;- lapply(bikes_uci[, 2:4], factor)
# convert date column to ymd format
bikes_uci$TripDate &lt;- ymd(bikes_uci$TripDate)
# add weekofmon (needed later for the other years&#39; holiday calculations)
bikes_uci &lt;- bikes_uci %&gt;%
  mutate(weekofmon = ifelse(between(day(TripDate),1,7), 1,
                            ifelse(between(day(TripDate),8,14), 2,
                                   ifelse(between(day(TripDate),15,21), 3, 4))))
# un-normalize temp; normalization formula: (t-t_min)/(t_max-t_min); t_max = 39, t_min=-8
bikes_uci$temp &lt;- 47*bikes_uci$temp - 8
# convert temp from celcius to farenheit
bikes_uci$temp &lt;- bikes_uci$temp * 9/5 + 32
# un-normalize humidity; normalization formula: hum/100
bikes_uci$hum &lt;- 100*bikes_uci$hum
# convert weekofmon to factor
bikes_uci$weekofmon &lt;- as.factor(bikes_uci$weekofmon)</code></pre>
</div>
<div id="capital-bikeshare-data-2013-2017" class="section level3">
<h3>Capital BikeShare Data (2013-2017)</h3>
<p>The five years of data amount to nearly 16 million rows combined. Since UCI’s data is aggregated on a daily scale, we do the same here and include variables found in the UCI dataset. The time-consuming task here is encoding whether or not a date is a federal holiday, since some holidays change dates year to year. <a href="https://www.thoughtco.com/public-holidays-in-the-united-states-3368327">ThoughtCo</a> has a helpful page describing the “calendar rules” of federal holidays. By creating calendar-based columns like month, week of month, and day of the week, we can easily create a function that checks calendar conditions satisfying a federal holiday.</p>
<pre class="r"><code>library(data.table)
############## Now we import and clean the 2013-2017 data ##############
# data can be found from [here](https://www.capitalbikeshare.com/system-data)
# read as data.table for faster import
b &lt;- list.files(full.names = TRUE)[1:20] %&gt;% 
  lapply(fread) %&gt;% 
  bind_rows

# convert to a dataframe to use dplyr functions
b &lt;- data.frame(b)

# convert Start date to ymd:hms format
b$Start.date &lt;- ymd_hms(b$Start.date, tz=&quot;US/Eastern&quot;)

# make a new column just with the date only
b$TripDate &lt;- as.Date(b$Start.date, tz=&quot;US/Eastern&quot;)

# compute number of cyclists by date
cyclists &lt;- b %&gt;% 
  group_by(TripDate) %&gt;% 
  summarise(casual = sum(Member.type == &quot;Casual&quot;),
            registered = sum(Member.type == &quot;Member&quot;),
            cnt = casual+registered) %&gt;%
  mutate(weekday = wday(TripDate),
         mnth = month(TripDate),
         weekofmon = ifelse(between(day(TripDate),1,7), 1,
                            ifelse(between(day(TripDate),8,14), 2,
                                   ifelse(between(day(TripDate),15,21), 3, 4))))

## - Let&#39;s define federal holidays
# fixed holidays
holidays &lt;- c(ymd(&quot;2013/01/01&quot;) + years(0:4), # New Years Day 
              ymd(&quot;2013/12/25&quot;) + years(0:4), # Christmas Day
              ymd(&quot;2013/11/11&quot;) + years(0:4), # Veterans Day
              ymd(&quot;2013/07/04&quot;) + years(0:4)) # Independence Day

# holidays that change dates; weekday ranges from 1-7, with 1 being Sunday
# info taken from https://www.thoughtco.com/public-holidays-in-the-united-states-3368327 
is_moving_hday &lt;- function() {
  # Thanksgiving - fourth Thursday of November
  (cyclists$mnth == 11 &amp; cyclists$weekofmon == 4 &amp; cyclists$weekday == 5) |
    # MLK&#39;s Birthday - third Monday of January
    (cyclists$mnth == 1 &amp; cyclists$weekofmon == 3 &amp; cyclists$weekday == 2) |
    # George Washington&#39;s Birthday - third Monday of February
    (cyclists$mnth == 2 &amp; cyclists$weekofmon == 3 &amp; cyclists$weekday == 2) |
    # Memorial Day - fourth Monday of May
    (cyclists$mnth == 5 &amp; cyclists$weekofmon == 4 &amp; cyclists$weekday == 2) |
    # Labor Day - first Monday of September
    (cyclists$mnth == 9 &amp; cyclists$weekofmon == 1 &amp; cyclists$weekday == 2) |
    # Columbus Day - second Monday of October
    (cyclists$mnth == 10 &amp; cyclists$weekofmon == 2 &amp; cyclists$weekday == 2)  
}

# create a holiday column in cyclists data frame
cyclists &lt;- cyclists %&gt;%
  mutate(holiday = ifelse((is_moving_hday() | 
                            TripDate %in% holidays), 1, 0))
# convert calendar variables to factor variables
cyclists[, 5:8] &lt;- lapply(cyclists[, 5:8], factor)</code></pre>
</div>
<div id="noaa-historical-weather-data-2011-2017" class="section level3">
<h3>NOAA Historical Weather Data (2011-2017)</h3>
<p>CB doesn’t include weather related variables like UCI does (the data contributor(s) added them separately), so we need to find this ourselves. It’s a fair assumption that temperature and precipitation affect ridership patterns so this is well worth finding. The data is included in my repository but here’s how you can get it yourself:</p>
<div id="go-to-httpswww.ncdc.noaa.govcdo-webdatasets" class="section level6">
<h6>1) go to <a href="https://www.ncdc.noaa.gov/cdo-web/datasets" class="uri">https://www.ncdc.noaa.gov/cdo-web/datasets</a></h6>
</div>
<div id="under-local-climatological-data-select-search-tool" class="section level6">
<h6>2) under Local Climatological Data, select “Search Tool”</h6>
</div>
<div id="choose-state-then-virginia" class="section level6">
<h6>3) choose State, then Virginia</h6>
</div>
<div id="navigate-to-washington-reagan-national-airport-closest-weather-station-to-dc" class="section level6">
<h6>4) navigate to Washington Reagan National Airport (closest weather station to DC)</h6>
</div>
<div id="click-add-to-cart" class="section level6">
<h6>5) click Add to Cart</h6>
</div>
<div id="go-to-your-cart-in-the-upper-right-hand-side-of-the-webpage-click-view-all-items" class="section level6">
<h6>6) go to your cart in the upper right hand side of the webpage; click View All Items</h6>
</div>
<div id="choose-lcd-csv-select-dates-2011-01-01-to-2017-12-31-then-click-continue" class="section level6">
<h6>7) choose LCD CSV, select dates 2011-01-01 to 2017-12-31, then click Continue</h6>
</div>
<div id="fill-in-your-email-to-get-the-data-then-click-submit-order" class="section level6">
<h6>8) fill in your email to get the data, then click Submit Order</h6>
</div>
<div id="the-data-will-take-a-couple-of-minutes-to-be-sent-to-your-email" class="section level6">
<h6>The data will take a couple of minutes to be sent to your email</h6>
<p>We’re only concerned with the date, temperature, precipitation, snow, wind speed, and humidity. Everything else can be discarded.</p>
<p>After examining the data we see December 31 info is missing for 2011, 2013 and 2014 so these are searched manually from <a href="https://www.timeanddate.com/weather/usa/washington-dc/historic">timeanddate</a>, averaging the four six-hour interval values for the aforementioned weather variables (data is given for 12am, 6am, 12pm, and 6pm). Precipitation and snow values denoted as <code>T</code> (trace amounts) are replaced with 0.</p>
<pre class="r"><code>####### ---------- Include (dry-bulb) temperature, humidity, and precipitation data -------------###
# change file path to match yours
dc_weather &lt;- read.csv(&quot;dcweather.csv&quot;)
# non-blank temps represent daily averages
dc_weather &lt;- filter(dc_weather, !is.na(DailyAverageDryBulbTemperature))
# keep date, temp, and humidity columns - find their column numbers first
cols_keep &lt;- match(c(&quot;DATE&quot;,&quot;DailyAverageDryBulbTemperature&quot;,&quot;DailyAverageRelativeHumidity&quot;,
                     &quot;DailyAverageWindSpeed&quot;, &quot;DailyPrecipitation&quot;, &quot;DailySnowfall&quot;), 
                   colnames(dc_weather))
# remove everything else
dc_weather &lt;- dc_weather[, cols_keep]
# shorten/rename columns
colnames(dc_weather) &lt;- c(&quot;TripDate&quot;, &quot;temp&quot;, &quot;hum&quot;, &quot;windspeed&quot;, &quot;prec&quot;, &quot;snow&quot;)
# remove &quot;T&quot; and time values from date column; first convert to character
# equivalent to keeping elements 1-10 of the date string
dc_weather$TripDate &lt;- as.character(dc_weather$TripDate)
dc_weather$TripDate &lt;- substring(dc_weather$TripDate,1,10)
# now convert TripDate column to TripDate object
dc_weather$TripDate &lt;- ymd(dc_weather$TripDate)
# quick check of weather data (using summary function) reveals
# T values in prec and snow; T means trace amounts, so we&#39;ll substitute 0 for T
# info taken from https://www1.ncdc.noaa.gov/pub/data/cdo/documentation/GHCND_documentation.pdf
# first need to convert from factor to character - can&#39;t directly substitute from factor
dc_weather[, 5:6] &lt;- apply(dc_weather[, 5:6], 2, function(x) as.character(x))
# now make the substitution
for (i in 5:6) {
  # if any value in column i equals T, replace with 0, otherwise keep original value
  dc_weather[, i] &lt;- ifelse(dc_weather[, i] == &quot;T&quot;, &quot;0&quot;, dc_weather[, i])
}
# change prec and snow columns to numeric type
dc_weather[, 5:6] &lt;- apply(dc_weather[, 5:6], 2, function(x) as.numeric(x))
# missing 12/31 date for 2011, 2013, and 2014. insert rows into dc_weather
# find row number Dec 30 for &#39;11, &#39;13, and &#39;14.
dec_30s &lt;- which(month(dc_weather$TripDate) == 12 &amp; 
                 day(dc_weather$TripDate) == 30 &amp;
                 year(dc_weather$TripDate) %in% c(2011,2013,2014))

# create a small dataframe to hold Dec 31 info
dec_31_info &lt;- data.frame(TripDate = ymd(c(&quot;2011/12/31&quot;, &quot;2013/12/31&quot;, &quot;2014/12/31&quot;)),
                          temp = c(58,41,36),
                          hum = c(62,49,43),
                          windspeed = c(9,11,7),
                          prec = c(0,0,0),
                          snow = c(0,0,0)
)

# cut and paste together all the weather data
dc_weather &lt;- rbind(dc_weather[1:364, ], # 1/1/2011 - 12/30/2011
                     dec_31_info[1,], # 12/31/2011
                     dc_weather[365:1094, ], # 1/1/2012 - 12/30/2013
                     dec_31_info[2, ], # 12/31/2013
                     dc_weather[1095:1458, ], # 1/1/2014 - 12/30/14
                     dec_31_info[3,], # 12/31/14
                     dc_weather[1459:2919, ] # everything else
                     )</code></pre>
</div>
</div>
<div id="combining-all-three-datasets" class="section level3">
<h3>Combining all three datasets</h3>
<p>Finally, we unite all three datasets to obtain 2011-2017 ridership data. First, we replace the deleted UCI weather data with the 2011-2012 info from NOAA. Then we update the CB data by attaching the NOAA weather data from 2013-2017 to it. Finally, we horizontally stack the UCI and CB data (2011-2012 on top, 2013-2017 on the bottom) to make one complete dataset called <code>bikes</code>.</p>
<pre class="r"><code>############## combining all three datasets ##############
# add prec and snow values for 2011 and 2012 to bikes_uci
# these are the substitutes for weathersit
bikes_uci &lt;- dc_weather %&gt;% 
  filter(between(TripDate, &quot;2011/01/01&quot;, &quot;2012/12/31&quot;)) %&gt;%
  select(TripDate, prec, snow) %&gt;%
  merge(bikes_uci, by=&quot;TripDate&quot;, all=T)

# merge dc_weather and cyclists -- this adds on the weather data to cyclists
bikes_temp &lt;- merge(cyclists, dc_weather, by=&quot;TripDate&quot;)
# now we have all 2013-2017 data.  need to combine this with UCI 2011-2012 data
# first need to reorder columns of bikes_uci (or bike_temp)
cols_matched &lt;- match(colnames(bikes_temp), colnames(bikes_uci))
bikes_uci &lt;- bikes_uci[, cols_matched]
# now merge horizontally (stack UCI data on top of 2013-2017)
bikes &lt;- bind_rows(bikes_uci, bikes_temp)</code></pre>
</div>
<div id="final-data-cleaning" class="section level3">
<h3>Final Data Cleaning</h3>
<p>Curiously, all humidity data from October 2013 is missing (as well as for four other dates).</p>
<pre class="r"><code>bikes[which(is.na(bikes$hum)), c(1,4,9:11)]</code></pre>
<pre><code>       TripDate   cnt temp hum windspeed
1005 2013-10-01 10255   72  NA       5.0
1006 2013-10-02 10249   76  NA       5.8
1007 2013-10-03 10059   76  NA       4.3
1008 2013-10-04 10158   78  NA       3.2
1009 2013-10-05 10456   79  NA       4.6
1010 2013-10-06  9650   80  NA       8.8
1011 2013-10-07  5797   68  NA      12.3
1012 2013-10-08  9829   62  NA       8.2
1013 2013-10-09  6360   60  NA      12.7
1014 2013-10-10  2491   58  NA      13.4
1015 2013-10-11  1775   62  NA      11.0
1016 2013-10-12  5191   66  NA      11.2
1017 2013-10-13  5938   63  NA      10.8
1018 2013-10-14  8818   64  NA       6.7
1019 2013-10-15  9272   64  NA       3.6
1020 2013-10-16  9629   68  NA       4.9
1021 2013-10-17  9468   70  NA       7.7
1022 2013-10-18 10256   61  NA       6.6
1023 2013-10-19  9309   60  NA       6.9
1024 2013-10-20  8493   58  NA       8.7
1025 2013-10-21  8956   57  NA       7.1
1026 2013-10-22  8990   60  NA       7.3
1027 2013-10-23  7884   54  NA       8.0
1028 2013-10-24  7823   48  NA       9.0
1029 2013-10-25  7866   48  NA       8.9
1030 2013-10-26  7906   46  NA      10.1
1031 2013-10-27  7917   53  NA       5.5
1032 2013-10-28  8515   55  NA       3.3
1033 2013-10-29  8949   55  NA       2.7
1034 2013-10-30  8055   59  NA       3.6
1035 2013-10-31  8335   62  NA       8.1
1520 2015-02-28  3222   27  NA       5.1
2013 2016-07-09 12198   86  NA       8.4
2157 2016-11-30  6170   61  NA       6.0
2247 2017-02-28  7828   58  NA       4.9</code></pre>
<p>Fortunately we can use past values to impute missing data. The ACF plot below quantifies how strong current and past humidity values are correlated, such as ~ 0.5 correlation between a given day’s value and yesterday’s value.</p>
<pre class="r"><code>Acf(bikes$hum, lag.max = 30, main=&quot;&quot;)
rect(xleft=0.5, ybottom=0, xright=1.5, ytop=0.53, border=&quot;red&quot;,lwd=2)
arrows(x0=4, y0=0.45, x1=2, y1=0.45, angle=20, col=&quot;red&quot;, length=.1)
text(x=3.7, y=0.45, labels = c(&quot;Lag 1&quot;), pos=4, cex=.85)
title(&quot;Humidity Autocorrelations&quot;, line=1)</code></pre>
<p><img src="/project/testing-mathjax-latex_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Using one day previous values of humidity would be great if we weren’t missing 31 consecutive days! However, if we assign a seasonality of 365 to humidity, decomposing the humidity data displays a strong annual pattern, as seen in the <code>seasonal</code> component below.</p>
<pre class="r"><code># remove NAs from humidity column
hum_2 &lt;- na.omit(bikes$hum)
# make into ts object
hum_2_ts &lt;- ts(hum_2, frequency = 365)
stl(hum_2_ts, s.window = &quot;periodic&quot;) %&gt;% autoplot() + xlab(&quot;Time (Years)&quot;) + theme_minimal()</code></pre>
<p><img src="/project/testing-mathjax-latex_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>So we resort to using last year’s date ( ~ 365 days) for each missing date since there’s evidence of annual seasonality. For example, we’ll use humidity from 10/12/2012 as a substitute for 10/12/2013. It’s quite natural to ask what last year’s value of something was if you’re missing this year’s data and have evidence of annual seasonality, as we do here.</p>
<pre class="r"><code>############## final data cleaning ##############
# find date of missing hum values and get the previous year&#39;s date
last_yrs &lt;- bikes[which(is.na(bikes$hum)), ]$TripDate - years(1)
# get the associated humidity values
last_hum &lt;- bikes %&gt;% 
  filter(TripDate %in% last_yrs) %&gt;%
  select(TripDate, hum)
# impute by first storing relevant row numbers
rows_to_impute &lt;- which(is.na(bikes$hum))
bikes[rows_to_impute, 10] &lt;- last_hum$hum
# to model trend (in MLR model), need to include time variable (Time)
# Time is simply the length of the time series (1:nrow(bikes))
bikes$Time &lt;- 1:nrow(bikes) </code></pre>
<p>Lastly, we create a variable named <code>Time</code> which ranges from 1 to the total number of rows in <code>bikes</code> 2553, which implies Day 1 through 2553 of the dataset. Later on we’ll use this to model trend in our regression models.</p>
</div>
<div id="summary" class="section level3">
<h3>Summary</h3>
<p>There’s a lot in this section! It reflects how many data science analyses go: 70-80% of time is spent data cleaning and feature engineering, and there’s even more of the latter later in the modeling stage as we improve model performance. For now let’s restate what we’ve done so far.</p>
<ul>
<li>Replace categorical weather info in the UCI dataset with numerical values of snow and precipitation from NOAA</li>
<li>Introduce week of month as an auxiliary feature, and use it alongside month of year to define federal holiday as a feature in the 2013-2017 data</li>
<li>Impute missing weather data missing from NOAA</li>
<li>Introduce a time variable to model trend (later in the analysis)</li>
</ul>
<p>At this point we can (finally) explore the data!</p>
</div>
</div>
<div id="exploratory-analysis" class="section level2">
<h2>Exploratory Analysis</h2>
<div id="data-dictionary" class="section level3">
<h3>Data Dictionary</h3>
<p>Before exploring, here’s a summary of all the variables and their meanings.</p>
<pre class="r"><code>library(kableExtra)
bike_variables &lt;- data.frame(Variable = c(&quot;TripDate&quot;, &quot;casual&quot;, &quot;registered&quot;, &quot;cnt&quot;, &quot;weekday&quot;, &quot;mnth&quot;, &quot;weekofmon&quot;, &quot;holiday&quot;, &quot;temp&quot;, &quot;hum&quot;, &quot;windspeed&quot;, &quot;prec&quot;, &quot;snow&quot;, &quot;Time&quot;),
                             Description = c(&quot;Date of record&quot;, &quot;Number of trips made by lower-tier membership plan riders&quot;, &quot;Number of trips made by upper-tier membership plan riders&quot;, &quot;Sum of the two previous columns&quot;, &quot;Day of the week. 1 = Sunday&quot;, &quot;Month of TripDate (1-12)&quot;, &quot;Week of month of the TripDate (1-4)&quot;, &quot;Is the TripDate a federal holiday? 1 = Yes&quot;, &quot;Temperature in Fahrenheit&quot;, &quot;Humidity expressed as a percent (maximum possible = 100)&quot;,&quot;Wind speed in miles per hour&quot;, &quot;Amount of precipitation (rain) in inches&quot;,&quot;Amount of snowfall in inches&quot;, &quot;Day Number (Day 1, Day 2, etc).  Used to model trend in regression models&quot;))

bike_variables %&gt;% kable() %&gt;% kable_styling(full_width = F, bootstrap_options = &quot;striped&quot;)</code></pre>
<table class="table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
Description
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
TripDate
</td>
<td style="text-align:left;">
Date of record
</td>
</tr>
<tr>
<td style="text-align:left;">
casual
</td>
<td style="text-align:left;">
Number of trips made by lower-tier membership plan riders
</td>
</tr>
<tr>
<td style="text-align:left;">
registered
</td>
<td style="text-align:left;">
Number of trips made by upper-tier membership plan riders
</td>
</tr>
<tr>
<td style="text-align:left;">
cnt
</td>
<td style="text-align:left;">
Sum of the two previous columns
</td>
</tr>
<tr>
<td style="text-align:left;">
weekday
</td>
<td style="text-align:left;">
Day of the week. 1 = Sunday
</td>
</tr>
<tr>
<td style="text-align:left;">
mnth
</td>
<td style="text-align:left;">
Month of TripDate (1-12)
</td>
</tr>
<tr>
<td style="text-align:left;">
weekofmon
</td>
<td style="text-align:left;">
Week of month of the TripDate (1-4)
</td>
</tr>
<tr>
<td style="text-align:left;">
holiday
</td>
<td style="text-align:left;">
Is the TripDate a federal holiday? 1 = Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
temp
</td>
<td style="text-align:left;">
Temperature in Fahrenheit
</td>
</tr>
<tr>
<td style="text-align:left;">
hum
</td>
<td style="text-align:left;">
Humidity expressed as a percent (maximum possible = 100)
</td>
</tr>
<tr>
<td style="text-align:left;">
windspeed
</td>
<td style="text-align:left;">
Wind speed in miles per hour
</td>
</tr>
<tr>
<td style="text-align:left;">
prec
</td>
<td style="text-align:left;">
Amount of precipitation (rain) in inches
</td>
</tr>
<tr>
<td style="text-align:left;">
snow
</td>
<td style="text-align:left;">
Amount of snowfall in inches
</td>
</tr>
<tr>
<td style="text-align:left;">
Time
</td>
<td style="text-align:left;">
Day Number (Day 1, Day 2, etc). Used to model trend in regression models
</td>
</tr>
</tbody>
</table>
<p>Our variable of interest to predict is <code>cnt</code>.</p>
</div>
<div id="overall-daily-ridership" class="section level3">
<h3>Overall Daily Ridership</h3>
<p>The line plot below is interactive, so feel free to click and drag around your mouse to zoom in on any portion. We see a clear positive trend and annual seasonality in ridership – for example, people tend to ride more during the summer than winter months.</p>
<p>The tall upward peaks in 2014 and 2015 most likely reflect high turnout at the annual National Cherry Blossom Festival.</p>
</div>
<div id="exploring-weather-variables-on-ridership" class="section level3">
<h3>Exploring Weather Variables on Ridership</h3>
<p>Below is a scatterplot matrix of continuous predictors (weather variables) plotted against each other and the response variable <code>cnt</code> (total number of trips). Some comments:</p>
<ul>
<li>No significant multicollinearity exists between the weather variables. This means regression coefficients for those variables should be stable</li>
<li>Only temperature is strongly correlated with trip numbers</li>
<li>Snowfall and precipitation negatively affect trips (as expected)</li>
</ul>
<pre class="r"><code>pairs(bikes[, c(4,9:13)], lower.panel = NULL, col=&quot;steelblue&quot;)</code></pre>
<p><img src="/project/testing-mathjax-latex_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
<div id="ridership-by-day-of-the-week" class="section level3">
<h3>Ridership by Day of the Week</h3>
<p>Trip patterns tend to fluctuate depending on day of week though not in a drastic way. Nevertheless people tend to ride more in the middle of the week (Wednesdays in particular, beginning in 2015) and less during the weekends.</p>
<pre class="r"><code>library(numform)
library(gganimate)
library(magick)
dow_animation &lt;- bikes %&gt;%
  group_by(weekday, Year = as.integer(year(TripDate))) %&gt;% 
  summarise(`Total Trips` = sum(cnt)) %&gt;%
  ggplot(aes(weekday, `Total Trips`)) + 
  geom_bar(stat = &quot;identity&quot;, fill=&quot;lightblue&quot;) +
  #geom_text(aes(label=paste0(round(`Total Trips`/1000), &quot;K&quot;)), vjust=1.6, size=3.5)+
  scale_x_discrete(labels = c(&quot;1&quot;=&quot;Sun&quot;, &quot;2&quot;=&quot;Mon&quot;, &quot;3&quot;=&quot;Tue&quot;,&quot;4&quot;=&quot;Wed&quot;,&quot;5&quot;=&quot;Thur&quot;,&quot;6&quot;=&quot;Fri&quot;,&quot;7&quot;=&quot;Sat&quot;))+
  scale_y_continuous(label=ff_thous(digits=2))+
  theme(panel.background = element_blank(),
        axis.ticks = element_blank()) +
  labs(title=&quot;Total Trips by Day of Week: {frame_time}&quot;,
       x = &quot;&quot;, y=&quot;Total Trips (in thousands)&quot;)+
  transition_time(Year)

dow_anim &lt;- animate(dow_animation, nframes = 50, renderer = magick_renderer())
# save as gif
anim_save(&quot;dayofweek.gif&quot;, dow_anim)</code></pre>
<p><img src="/post/pvalues_intuitive_files/dayofweek.gif" /></p>
</div>
</div>
